name: Build Ubuntu 24.04 VirtualBox VM

# Workflow triggers
# This workflow is triggered manually via GitHub Actions UI
on:
  # Manual trigger via GitHub Actions UI (workflow_dispatch)
  # Allows manually starting the build from the Actions tab
  workflow_dispatch:

# Environment variables used throughout the workflow
env:
  # Name of the Packer template file (without path)
  PACKER_TEMPLATE: ubuntu-24.04-virtualbox.pkr.hcl
  # Directory where Packer configuration files are stored
  PACKER_DIR: packer
  # Directory where Packer will output the built VM image
  OUTPUT_DIR: output-ubuntu

jobs:
  build-vm:
    # Runner configuration
    # VirtualBox is pre-installed on GitHub-hosted Ubuntu runners
    runs-on: ubuntu-latest
    
    # Permissions required for this job
    permissions:
      # Read repository contents (needed to checkout code)
      contents: write  # write needed for creating releases
      
    steps:
      # Step 1: Check out the repository code
      # This downloads the repository files to the runner so we can access
      # the Packer templates, scripts, and configuration files
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Set up VirtualBox
      # GitHub-hosted Ubuntu runners have VirtualBox pre-installed, but we
      # verify it's available and check the version
      - name: Verify VirtualBox installation
        run: |
          # Check if VirtualBox is installed and print version
          echo "Checking VirtualBox installation..."
          vboxmanage --version
          
          # List available VM types to confirm VirtualBox is working
          echo "Available VirtualBox VM types:"
          vboxmanage list ostypes | grep -i ubuntu | head -n 5
      
      # Step 3: Install Packer
      # Using the official HashiCorp setup-packer action
      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"
      
      # Step 4: Initialize Packer
      # Download required Packer plugins specified in the template
      - name: Initialize Packer
        run: |
          # Change to the Packer directory where our template is located
          cd ${{ env.PACKER_DIR }}
          
          # Initialize Packer - downloads required plugins (e.g., VirtualBox plugin)
          echo "Initializing Packer and downloading plugins..."
          packer init ${{ env.PACKER_TEMPLATE }}
      
      # Step 5: Validate Packer template
      # Check that the Packer configuration is syntactically correct
      # This catches configuration errors before attempting the build
      - name: Validate Packer template
        run: |
          cd ${{ env.PACKER_DIR }}
          
          # Validate the template syntax and configuration
          echo "Validating Packer template..."
          packer validate ${{ env.PACKER_TEMPLATE }}
          
          echo "Packer template validation passed!"
      
      # Step 6: Build the VM image
      # This is the main build step that creates the VM
      # WARNING: This step can take 20-40 minutes depending on the runner
      # Timeout is set to 60 minutes to prevent indefinite hanging
      - name: Build VM with Packer
        timeout-minutes: 60
        run: |
          cd ${{ env.PACKER_DIR }}
          
          # Build the VM using the Packer template
          # The build process will:
          # 1. Download the Ubuntu ISO (if not cached)
          # 2. Create a new VirtualBox VM
          # 3. Boot the ISO and perform automated installation
          # 4. Wait for SSH to become available
          # 5. Run provisioning scripts to install Docker and VS Code
          # 6. Shut down the VM and export as OVA
          echo "Starting Packer build..."
          echo "This may take 20-40 minutes. Please be patient..."
          
          # Run the build with color output disabled for cleaner logs
          packer build -color=false ${{ env.PACKER_TEMPLATE }}
          
          echo "Packer build completed successfully!"
      
      # Step 7: Prepare artifacts for upload
      # Collect the built VM files for artifact upload and release attachment
      - name: Prepare artifacts
        run: |
          # Create a clean directory for artifacts
          mkdir -p vm-artifacts
          
          # Find and copy the OVA file to the artifacts directory
          # Packer creates the OVA in the output directory
          echo "Locating built VM image..."
          find ${{ env.PACKER_DIR }} -name "*.ova" -exec cp {} vm-artifacts/ \;
          
          # Copy the manifest file if it exists
          # The manifest contains metadata about the build
          if [ -f "${{ env.PACKER_DIR }}/packer-manifest.json" ]; then
            cp ${{ env.PACKER_DIR }}/packer-manifest.json vm-artifacts/
          fi
          
          # List the artifacts that will be uploaded
          echo "Artifacts prepared for upload:"
          ls -lh vm-artifacts/
      
      # Step 8: Upload VM image as a workflow artifact
      # This makes the VM image downloadable from the GitHub Actions run page
      # Artifacts are retained for 90 days by default
      - name: Upload VM image as artifact
        uses: actions/upload-artifact@v4
        with:
          # Name of the artifact as it will appear in the Actions UI
          name: ubuntu-24.04-virtualbox-vm
          # Path to the files to upload
          path: vm-artifacts/*
          # Retention period in days (90 is the maximum for free GitHub accounts)
          retention-days: 90
      
      # Step 9: Create GitHub Release
      # Create a release and attach the VM image for every build
      # This provides a permanent download location for the VM
      - name: Create Release and Upload Asset
        env:
          # GitHub token for authentication (automatically provided by GitHub Actions)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Generate a release name based on the workflow run
          # Use tag if available, otherwise use run number and timestamp
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Extract the tag name from the git reference
            # refs/tags/v1.0.0 -> v1.0.0
            RELEASE_NAME=${GITHUB_REF#refs/tags/}
            RELEASE_TAG="$RELEASE_NAME"
          else
            # For non-tagged builds, create a unique release name
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            RELEASE_TAG="build-${{ github.run_number }}-${TIMESTAMP}"
            RELEASE_NAME="Build #${{ github.run_number }} - ${TIMESTAMP}"
          fi
          
          echo "Creating release: $RELEASE_NAME"
          echo "Release tag: $RELEASE_TAG"
          
          # Find the OVA file to attach to the release
          OVA_FILE=$(find vm-artifacts -name "*.ova" | head -n 1)
          
          if [ -z "$OVA_FILE" ]; then
            echo "Error: No OVA file found in vm-artifacts/"
            exit 1
          fi
          
          echo "Found OVA file: $OVA_FILE"
          
          # Create a GitHub release using the GitHub CLI
          # The release includes:
          # - Title: The release name
          # - Notes: Description of the VM and installation instructions
          # - Asset: The VM OVA file
          gh release create "$RELEASE_TAG" \
            --title "Ubuntu 24.04 VirtualBox VM - $RELEASE_NAME" \
            --notes "## Ubuntu 24.04 LTS VirtualBox VM Image

          This release contains a pre-built VirtualBox VM image with:
          - **OS**: Ubuntu 24.04 LTS (Noble Numbat)
          - **Docker Engine**: Latest stable version
          - **Visual Studio Code**: Latest stable version
          - **User**: packer (password: packer)
          - **Resources**: 2 vCPUs, 4 GB RAM, 40 GB disk
          
          ### How to Use:
          1. Download the \`.ova\` file below
          2. Open VirtualBox
          3. Go to File → Import Appliance
          4. Select the downloaded \`.ova\` file
          5. Follow the import wizard (adjust resources if needed)
          6. Start the VM and log in with username: \`packer\`, password: \`packer\`
          
          ### Included Software:
          - Docker Engine (user 'packer' is in docker group, no sudo needed)
          - Docker Compose plugin
          - Visual Studio Code
          - Git, curl, wget, build-essential
          
          ### Security Notes:
          - Default password is \`packer\` - **change it immediately** after first login
          - SSH is enabled with password authentication
          - User 'packer' has sudo privileges without password prompt
          
          For more information, see the repository README." \
            "$OVA_FILE"
          
          echo "Release created successfully with VM image attached!"
      
      # Step 10: Summary
      # Provide a helpful summary at the end of the workflow
      - name: Workflow Summary
        if: always()
        run: |
          echo "============================================"
          echo "Workflow Summary"
          echo "============================================"
          echo ""
          
          if [ -d "vm-artifacts" ] && [ "$(ls -A vm-artifacts/*.ova 2>/dev/null)" ]; then
            echo "✓ VM image built successfully"
            echo ""
            echo "Download options:"
            echo "1. Workflow artifact: Click the 'ubuntu-24.04-virtualbox-vm' artifact above"
            echo "2. Release asset: Check the Releases section for this build's release"
            echo ""
            echo "VM Details:"
            echo "- OS: Ubuntu 24.04 LTS"
            echo "- User: packer (password: packer)"
            echo "- Docker: Installed and configured"
            echo "- VS Code: Installed"
            echo "- Resources: 2 vCPUs, 4 GB RAM, 40 GB disk"
          else
            echo "✗ VM image build failed or artifacts not found"
            echo "Check the logs above for errors"
          fi
          
          echo ""
          echo "============================================"
